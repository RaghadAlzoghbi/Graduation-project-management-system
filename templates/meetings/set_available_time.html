<!-- set available time -->
{% extends 'base.html' %}
{% load static i18n %}
{% block title %}{% trans "Set Available Times" %}{% endblock %}
{% block head %}
<link rel="stylesheet" href="{% static 'css/meeting/set_availabilty.css' %}">
{% endblock %}

{% block content %}

{% include "navbar.html" %}

<div id="availability-container">
  <div id="alert-success">{% trans "‚úÖ Successfully saved!" %}</div>

  <h2 style="text-align: center; margin-bottom: 30px;">‚è≥ {% trans "Set Your Available Times" %}</h2>

  <!-- Day blocks dynamically populated below -->
  <div id="days-container">
    <!-- Each day will be populated here dynamically -->
  </div>

  <button type="button" class="save-button btn-primary" onclick="saveAvailability()">üíæ {% trans "Save All" %}</button>
</div>

<script>
  // CSRF Token Helper
  function getCSRFToken() {
    let cookieValue = null;
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.startsWith('csrftoken=')) {
        cookieValue = decodeURIComponent(cookie.substring('csrftoken='.length));
        break;
      }
    }
    return cookieValue;
  }

  const dayMap = {
    mon: gettext('Monday'),
    tue: gettext('Tuesday'),
    wed: gettext('Wednesday'),
    thu: gettext('Thursday'),
    fri: gettext('Friday'),
    sat: gettext('Saturday'),
    sun: gettext('Sunday'),
  };

  function showSuccess(message, color = '#198754') {
    const alert = document.getElementById('alert-success');
    alert.textContent = message;
    alert.style.backgroundColor = color;
    alert.style.display = 'block';
    setTimeout(() => {
      alert.style.display = 'none';
    }, 2500);
  }

  function fetchAvailability() {
    fetch('/api/set-available-time/')
      .then(res => res.json())
      .then(data => {
        const grouped = {};
        data.forEach(entry => {
          if (!grouped[entry.day]) grouped[entry.day] = [];
          grouped[entry.day].push(entry);
        });

        const daysContainer = document.getElementById('days-container');
        daysContainer.innerHTML = ''; // Clear existing days

        Object.entries(dayMap).forEach(([dayCode, dayName]) => {
          const dayBlock = createDayBlock(dayCode, dayName, grouped[dayCode] || []);
          daysContainer.appendChild(dayBlock);
        });
      });
  }

  function createDayBlock(dayCode, dayName, slots) {
    const dayBlock = document.createElement('div');
    dayBlock.classList.add('day-block');
    dayBlock.dataset.day = dayCode;

    const dayHeader = document.createElement('h3');
    dayHeader.textContent = dayName;
    dayBlock.appendChild(dayHeader);

    const timeSlotsContainer = document.createElement('div');
    timeSlotsContainer.classList.add('time-slots');
    timeSlotsContainer.id = 'slots-' + dayCode;
    dayBlock.appendChild(timeSlotsContainer);

    if (slots.length === 0) {
      const noSlotsMessage = document.createElement('p');
      noSlotsMessage.classList.add('no-slots');
      noSlotsMessage.textContent = gettext('Not available');
      timeSlotsContainer.appendChild(noSlotsMessage);
    } else {
      slots.forEach(slot => {
        timeSlotsContainer.appendChild(createTimeSlotRow(slot.start_time, slot.end_time, dayCode, true));
      });
    }

    const addSlotButton = document.createElement('button');
    addSlotButton.textContent = '+ ' + gettext('Add Time Slot');
    addSlotButton.onclick = () => addTimeSlot(dayCode);
    dayBlock.appendChild(addSlotButton);

    return dayBlock;
  }

  function createTimeSlotRow(start, end, dayCode, saved = false) {
    const row = document.createElement('div');
    row.classList.add('slot-row');
    row.dataset.day = dayCode;
    row.dataset.saved = saved ? 'true' : 'false';

    row.innerHTML = `
      ${createTimeDropdown('start', start)}
      <span>${gettext('to')}</span>
      ${createTimeDropdown('end', end)}
      <button type="button" class="delete-slot-btn btn-delete">üóëÔ∏è ${gettext('Remove')}</button>
    `;

    row.querySelector('.delete-slot-btn').addEventListener('click', function () {
      const confirmed = window.confirm(gettext("Are you sure you want to delete this time slot?"));
      if (!confirmed) return;

      if (row.dataset.saved !== 'true') {
        row.remove();
        showSuccess('üóëÔ∏è ' + gettext('Time slot removed!'));
        return;
      }

      const startHour = row.querySelector('.start-hour').value;
      const startMinute = row.querySelector('.start-minute').value;
      const startAmPm = row.querySelector('.start-ampm').value;

      const endHour = row.querySelector('.end-hour').value;
      const endMinute = row.querySelector('.end-minute').value;
      const endAmPm = row.querySelector('.end-ampm').value;

      const start = convertTo24Hour(startHour, startMinute, startAmPm);
      const end = convertTo24Hour(endHour, endMinute, endAmPm);

      const day = row.dataset.day;

      fetch('/api/delete-available-time/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({
          day: day,
          start_time: start,
          end_time: end
        })
      })
      .then(res => {
        if (res.ok) {
          row.remove();
          showSuccess('‚úÖ ' + gettext('Time slot deleted!'));
        } else {
          alert('‚ùå ' + gettext('Error deleting time slot.'));
        }
      })
      .catch(error => console.error("Error deleting time slot:", error));
    });

    return row;
  }

  function createTimeDropdown(type, time) {
    let hour = '';
    let minute = '00';
    let ampm = 'AM';

    if (time) {
      const [h, m] = time.split(':');
      let hourInt = parseInt(h);
      minute = m;
      if (hourInt >= 12) {
        ampm = 'PM';
        if (hourInt > 12) hourInt -= 12;
      }
      if (hourInt == 0) hourInt = 12;
      hour = hourInt.toString().padStart(2, '0');
    }

    const hours = [...Array(12).keys()].map(i => {
      const val = (i + 1).toString().padStart(2, '0');
      return `<option value="${val}" ${val == hour ? 'selected' : ''}>${val}</option>`;
    }).join('');

    return `
      <select class="${type}-hour">${hours}</select>
      <input type="number" min="0" max="59" value="${minute}" class="${type}-minute" style="width:50px;" />
      <select class="${type}-ampm">
        <option value="AM" ${ampm == 'AM' ? 'selected' : ''}>AM</option>
        <option value="PM" ${ampm == 'PM' ? 'selected' : ''}>PM</option>
      </select>
    `;
  }

  function addTimeSlot(dayCode) {
    const container = document.querySelector(`#slots-${dayCode}`);
    const noSlot = container.querySelector('.no-slots');
    if (noSlot) noSlot.remove();
    container.appendChild(createTimeSlotRow('', '', dayCode, false));
  }

  function convertTo24Hour(hour, minute, ampm) {
    hour = parseInt(hour);
    minute = minute.toString().padStart(2, '0');
    if (ampm === 'PM' && hour !== 12) {
      hour += 12;
    }
    if (ampm === 'AM' && hour === 12) {
      hour = 0;
    }
    return `${hour.toString().padStart(2, '0')}:${minute}`;
  }

  function saveAvailability() {
    const payload = [];
    const slotSet = new Set();
    let duplicateFound = false;

    document.querySelectorAll('.day-block').forEach(dayBlock => {
      const day = dayBlock.dataset.day;

      dayBlock.querySelectorAll('.slot-row').forEach(row => {
        if (row.dataset.saved === 'true') return;

        const startHour = row.querySelector('.start-hour').value;
        const startMinute = row.querySelector('.start-minute').value;
        const startAmPm = row.querySelector('.start-ampm').value;

        const endHour = row.querySelector('.end-hour').value;
        const endMinute = row.querySelector('.end-minute').value;
        const endAmPm = row.querySelector('.end-ampm').value;

        const start = convertTo24Hour(startHour, startMinute, startAmPm);
        const end = convertTo24Hour(endHour, endMinute, endAmPm);

        const slotKey = `${day}-${start}-${end}`;
        if (slotSet.has(slotKey)) {
          duplicateFound = true;
        } else {
          slotSet.add(slotKey);
          if (start && end) {
            payload.push({ day, start_time: start, end_time: end });
          }
        }
      });
    });

    if (duplicateFound) {
      showSuccess('‚ö†Ô∏è ' + gettext('Duplicate time slot!'), '#fdc51d');
      return;
    }

    if (payload.length === 0) {
      showSuccess('‚ö†Ô∏è ' + gettext('No new time slots to save.'), '#fdc51d');
      return;
    }

    fetch('/api/set-available-time/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken()
      },
      body: JSON.stringify(payload)
    })
    .then(res => {
      if (res.ok) {
        fetchAvailability();
        showSuccess('‚úÖ ' + gettext('Times saved!'));
      } else {
        alert('‚ùå ' + gettext('Error saving!'));
      }
    })
    .catch(error => console.error("Error saving times:", error));
  }

  document.addEventListener('DOMContentLoaded', fetchAvailability);
</script>

{% endblock %}
