{% extends "base.html" %}

{% block content %}
<h2>Edit Evaluation Form</h2>

<form id="evaluation-form">
    <label>Form Name:</label>
    <input type="text" id="form-name" value="{{ form.name }}" required>

    <div id="main-categories">
        <h3>Main Categories</h3>
        <button type="button" onclick="addMainCategory()">Add Main Category</button>

        {% for main_category in form.main_categories.all %}
        <div class="main-category">
            <h4>Main Category {{ main_category.number }}</h4>
            <label>Text:</label> 
            <input type="text" name="main_category_text" value="{{ main_category.text }}" required>
            
            <label>Weight:</label> 
            <input type="number" name="main_category_weight" value="{{ main_category.weight }}" required>

            <label>Grade Type:</label>
            <select name="main_category_grade_type">
                <option value="individual" {% if main_category.grade_type == 'individual' %}selected{% endif %}>Individual</option>
                <option value="group" {% if main_category.grade_type == 'group' %}selected{% endif %}>Group</option>
            </select>

            <div class="sub-categories">
                <h5>Subcategories</h5>
                <button type="button" onclick="addSubCategory(this)">Add Subcategory</button>

                {% for sub_category in main_category.sub_categories.all %}
                <div>
                    <label>Subcategory:</label> 
                    <input type="text" name="sub_category_text" value="{{ sub_category.text }}" required>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>

    <button type="submit">Update Form</button>
</form>

<script>
    function addMainCategory() {
        const container = document.getElementById("main-categories");
        const count = container.getElementsByClassName("main-category").length + 1;

        let div = document.createElement("div");
        div.classList.add("main-category");
        div.innerHTML = `
            <h4>Main Category ${count}</h4>
            <label>Text:</label> <input type="text" name="main_category_text" required>
            <label>Weight:</label> <input type="number" name="main_category_weight" required>
            <label>Grade Type:</label>
            <select name="main_category_grade_type">
                <option value="individual">Individual</option>
                <option value="group">Group</option>
            </select>
            <div class="sub-categories">
                <h5>Subcategories</h5>
                <button type="button" onclick="addSubCategory(this)">Add Subcategory</button>
            </div>
        `;
        container.appendChild(div);
    }

    function addSubCategory(button) {
        const container = button.parentElement;
        let div = document.createElement("div");
        div.innerHTML = `<label>Subcategory:</label> <input type="text" name="sub_category_text" required>`;
        container.appendChild(div);
    }

    document.getElementById("evaluation-form").onsubmit = function (e) {
        e.preventDefault();

        let formData = {
            name: document.getElementById("form-name").value,
            main_categories: []
        };

        document.querySelectorAll(".main-category").forEach((category, index) => {
            let mainCategory = {
                number: index + 1,
                text: category.querySelector("[name='main_category_text']").value,
                weight: parseFloat(category.querySelector("[name='main_category_weight']").value),
                grade_type: category.querySelector("[name='main_category_grade_type']").value,
                sub_categories: []
            };

            category.querySelectorAll(".sub-categories input[name='sub_category_text']").forEach(sub => {
                mainCategory.sub_categories.push({ text: sub.value });
            });

            formData.main_categories.push(mainCategory);
        });

        fetch("{% url 'form:edit_evaluation_form' form.id %}", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(formData)
        }).then(response => response.json())
          .then(data => {
              alert(data.message || "Form updated successfully!");
              window.location.href = "{% url 'form:evaluation_form_list' %}";
          });
    };
</script>
{% endblock %}
